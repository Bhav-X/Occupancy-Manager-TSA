<script>
    // --- CONFIGURATION ---
    const RENDER_URL = "https://occupancy-wall.onrender.com"; 
    const READ_TOKEN = "occupancy_Manager@1153";

    // UI Elements (Using your exact IDs)
    const circle = document.getElementById("status-indicator");
    const label = document.getElementById("status-label");
    const debugText = document.getElementById("heartbeat-debug");
    const logBox = document.getElementById("console-log");

    // --- 1. THE WATCHER (Keeps your UI live) ---
    setInterval(async () => {
        try {
            const response = await fetch(`${RENDER_URL}/api/status`, {
                headers: { "Authorization": `Bearer ${READ_TOKEN}` }
            });
            const data = await response.json();

            // Update Room Status (FREE/BUSY)
            const currentRoomStatus = data.roomStatus || "UNKNOWN";
            updateDisplay(currentRoomStatus);
            
            // Update Heartbeat
            if (data.admin?.heartbeat) {
                const secondsAgo = Math.floor((Date.now() - data.admin.heartbeat) / 1000);
                debugText.innerText = (secondsAgo > 30) ? "Scanner Offline" : `Last signal: ${secondsAgo}s ago`;
            }

            // Update Console Log from ESP32
            if (data.admin?.result) {
                logBox.innerText = "> ESP32: " + data.admin.result;
            }

        } catch (err) {
            console.error("Connection Error");
        }
    }, 2000);

    // --- 2. THE CORE FUNCTIONS (What you actually asked for) ---

    // Generic function to send commands (Enroll, Toggle, Check Count)
    async function runCmd(commandString) {
        const key = document.getElementById("adminKey").value;
        if (!key) return alert("Enter Admin Key!");

        logBox.innerText = "> Sending: " + commandString;

        await fetch(`${RENDER_URL}/api/command`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                cmd: commandString.toUpperCase(), // e.g., "ENROLL", "STATUS_CHANGE"
                key: key 
            })
        });

        // Auto-reset command to "0" after 5 seconds so it doesn't loop
        setTimeout(() => resetCommand(), 5000);
    }

    // Specific function for "Delete ID" since it needs a number
    async function deleteSpecificId() {
        const key = document.getElementById("adminKey").value;
        const idNum = document.getElementById("deleteIdInput").value;
        
        if (!key || !idNum) return alert("Enter Key and ID#!");

        logBox.innerText = `> Sending: DELETE ID ${idNum}`;

        await fetch(`${RENDER_URL}/api/command`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                cmd: "DELETE_ID", 
                id: idNum, 
                key: key 
            })
        });

        setTimeout(() => resetCommand(), 5000);
    }

    // Reset helper
    async function resetCommand() {
        await fetch(`${RENDER_URL}/api/command`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cmd: "0", key: "0" })
        });
    }

    // --- 3. UI DISPLAY ENGINE ---
    function updateDisplay(status) {
        circle.className = "status-circle"; // Reset
        circle.innerText = status;

        if (status === "FREE") {
            circle.classList.add("status-free");
            label.innerText = "Room is Available";
        } else if (status === "BUSY") {
            circle.classList.add("status-busy");
            label.innerText = "Do Not Disturb";
        } else {
            circle.classList.add("status-offline");
            circle.innerText = "OFF";
            label.innerText = "System Offline";
        }
    }

    function toggleAdmin() {
        const panel = document.getElementById("admin-panel");
        panel.style.display = (panel.style.display === "block") ? "none" : "block";
    }
</script>
